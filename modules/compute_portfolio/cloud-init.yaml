#cloud-config
package_update: true
package_upgrade: true
packages:
  - docker.io      # or podman
  - nginx
  - curl
  - iptables-persistent
  - python3-certbot-nginx
  - certbot

runcmd:
  # -----------------------------
  # 1. Set firewall rules
  # -----------------------------
  - iptables -I INPUT -p tcp --dport 80 -j ACCEPT
  - iptables -I INPUT -p tcp --dport 443 -j ACCEPT
  - iptables-save > /etc/iptables/rules.v4   # persist rules

  # -----------------------------
  # 2. Pull the docker image
  # -----------------------------
  - docker pull ${docker_image}

  # -----------------------------
  # 3. Stop & remove any existing container
  # -----------------------------
  - docker rm -f ${container_name} || true

  # -----------------------------
  # 4. Run the container
  # -----------------------------
  - docker run -d --name ${container_name} -p ${container_port}:80 ${docker_image}

  # -----------------------------
  # 5. Configure nginx reverse proxy
  # -----------------------------
  - |
    cat > /etc/nginx/sites-available/${container_name} <<EOF
    server {
        listen 80;
        server_name ${domains};

        location / {
            proxy_pass http://127.0.0.1:${container_port};
            proxy_set_header Host \$host;
            proxy_set_header X-Real-IP \$remote_addr;
            proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        }
    }
    EOF
  - ln -sf /etc/nginx/sites-available/${container_name} /etc/nginx/sites-enabled/${container_name}
  - rm -f /etc/nginx/sites-enabled/default
  - nginx -t
  - systemctl restart nginx
  
  # Give nginx time to fully start and be ready for certbot validation
  # DNS propagation can take time, so we give it plenty of room
  - sleep 20
  
  # -----------------------------
  # 6. Issue SSL certificates with aggressive retry logic
  # -----------------------------
  - |
    DOMAINS="${domains}"
    DOMAIN_ARGS=""
    for domain in $DOMAINS; do
      DOMAIN_ARGS="$DOMAIN_ARGS -d $domain"
    done
    
    for attempt in 1 2 3 4 5; do
      echo "Attempt $attempt to issue certificate..."
      if certbot --nginx --non-interactive --agree-tos -m ${email} $DOMAIN_ARGS; then
        echo "Certificate issued successfully on attempt $attempt"
        break
      else
        echo "Attempt $attempt failed, waiting 15 seconds before retry..."
        sleep 15
      fi
    done
  
  - certbot renew --dry-run || true