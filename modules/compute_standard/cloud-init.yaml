#cloud-config
package_update: true
package_upgrade: true
packages:
  - docker.io      # or podman
  - nginx
  - curl
  - iptables-persistent
  - python3-certbot-nginx
  - certbot

runcmd:
  # -----------------------------
  # 1. Set firewall rules
  # -----------------------------
  - iptables -I INPUT -p tcp --dport 80 -j ACCEPT
  - iptables -I INPUT -p tcp --dport 443 -j ACCEPT
  - iptables-save > /etc/iptables/rules.v4   # persist rules

  # -----------------------------
  # 2. Pull the latest portfolio image from DockerHub
  # -----------------------------
  - docker pull clepo123/main:latest

  # -----------------------------
  # 3. Stop & remove any existing container
  # -----------------------------
  - docker rm -f portfolio || true

  # -----------------------------
  # 4. Run the container
  # -----------------------------
  - docker run -d --name portfolio -p 8082:80 clepo123/main:latest

  # -----------------------------
  # 5. Configure nginx reverse proxy
  # -----------------------------
  - |
    cat > /etc/nginx/sites-available/portfolio <<EOF
    server {
        listen 80;
        server_name pabloberrettoni.com www.pabloberrettoni.com;

        location / {
            proxy_pass http://127.0.0.1:8082;
            proxy_set_header Host \$host;
            proxy_set_header X-Real-IP \$remote_addr;
            proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        }
    }
    EOF
  - ln -sf /etc/nginx/sites-available/portfolio /etc/nginx/sites-enabled/portfolio
  - rm -f /etc/nginx/sites-enabled/default
  - nginx -t
  - systemctl restart nginx
  - certbot --nginx --non-interactive --agree-tos -m pabloberrettoni98@gmail.com -d pabloberrettoni.com -d www.pabloberrettoni.com
  - certbot renew --dry-run
